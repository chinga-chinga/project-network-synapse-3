# Deploy to dev/staging/prod
name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      version:
        description: "Version to deploy (tag, branch, or SHA)"
        required: false
        default: "main"

  # Auto-deploy: staging on develop push, prod on main push
  push:
    branches: [develop, main]

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  # ─────────────────────────────────────────────
  # Pre-deployment validation
  # ─────────────────────────────────────────────
  validate:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    outputs:
      deploy_env: ${{ steps.env.outputs.environment }}
      deploy_ref: ${{ steps.env.outputs.ref }}
    steps:
      - name: Determine environment and ref
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> "$GITHUB_OUTPUT"
            echo "ref=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.ref_name }}" = "main" ]; then
            echo "environment=prod" >> "$GITHUB_OUTPUT"
            echo "ref=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "environment=staging" >> "$GITHUB_OUTPUT"
            echo "ref=${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.env.outputs.ref }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Run quality checks
        run: uv run invoke check-all

      - name: Run unit tests
        run: uv run invoke backend.test-unit

  # ─────────────────────────────────────────────
  # Deploy to GCP VM via SSH
  # ─────────────────────────────────────────────
  deploy:
    name: Deploy to ${{ needs.validate.outputs.deploy_env }}
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ needs.validate.outputs.deploy_env }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Resolve deploy branch
        id: branch
        run: |
          ENV="${{ needs.validate.outputs.deploy_env }}"
          if [ "$ENV" = "prod" ]; then
            echo "name=origin/main" >> "$GITHUB_OUTPUT"
          else
            echo "name=origin/develop" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to VM
        env:
          REMOTE_HOST: ${{ secrets.VM_HOST }}
          REMOTE_USER: ${{ secrets.VM_USER || 'anton' }}
          DEPLOY_BRANCH: ${{ steps.branch.outputs.name }}
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          SSH_OPTS="-i $SSH_KEY -o StrictHostKeyChecking=no -o ConnectTimeout=15"

          echo "══════════════════════════════════════"
          echo "  Deploying to: $REMOTE_HOST"
          echo "  Environment:  ${{ needs.validate.outputs.deploy_env }}"
          echo "  Branch:       $DEPLOY_BRANCH"
          echo "══════════════════════════════════════"

          # Pull latest code
          ssh $SSH_OPTS ${REMOTE_USER}@${REMOTE_HOST} "
            export PATH=\$HOME/.local/bin:\$PATH
            cd ~/project-network-synapse-3
            git fetch origin
            git reset --hard ${DEPLOY_BRANCH}
            git submodule update --init --recursive
            uv sync --all-groups
          "

          # Restart the worker
          ssh $SSH_OPTS ${REMOTE_USER}@${REMOTE_HOST} "
            sudo systemctl restart synapse-worker
          "

          echo "Deployment complete"

  # ─────────────────────────────────────────────
  # Post-deployment health check
  # ─────────────────────────────────────────────
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    steps:
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Verify deployment
        env:
          REMOTE_HOST: ${{ secrets.VM_HOST }}
          REMOTE_USER: ${{ secrets.VM_USER || 'anton' }}
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          SSH_OPTS="-i $SSH_KEY -o StrictHostKeyChecking=no -o ConnectTimeout=15"

          echo "Running health checks..."

          ssh $SSH_OPTS ${REMOTE_USER}@${REMOTE_HOST} "
            # Worker is running
            sudo systemctl is-active synapse-worker && echo '✓ Worker active' || echo '✗ Worker down'

            # Temporal responds
            curl -s -o /dev/null -w 'Temporal UI: HTTP %{http_code}\n' http://localhost:8080

            # Infrahub responds
            curl -s -o /dev/null -w 'Infrahub:    HTTP %{http_code}\n' http://localhost:8000
          "

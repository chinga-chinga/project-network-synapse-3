# CI â€” runs on push to develop (superset of PR validation)
name: CI

on:
  push:
    branches: [develop]

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Black format check
        run: black --check --diff .

      - name: isort import sorting check
        run: isort --check-only --diff .

      - name: Pylint
        run: pylint **/*.py --rcfile=.pylintrc --output-format=colorized
        continue-on-error: true

      - name: MyPy type checking
        run: mypy . --config-file=mypy.ini --show-error-codes
        continue-on-error: true

  security-scanning:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Bandit security scan (JSON report)
        run: bandit -r scripts/ temporal_workers/ infrahub/ -f json -o bandit-report.json --exit-zero
        continue-on-error: true

      - name: Bandit security scan (SARIF report)
        run: |
          bandit -r scripts/ temporal_workers/ infrahub/ -f sarif -o bandit-results.sarif --exit-zero || true
          # Ensure SARIF file exists even if bandit fails entirely
          if [ ! -f bandit-results.sarif ]; then
            echo '{"version":"2.1.0","$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/main/sarif-2.1/schema/sarif-schema-2.1.0.json","runs":[{"tool":{"driver":{"name":"Bandit","version":"0.0.0"}},"results":[]}]}' > bandit-results.sarif
          fi

      - name: Upload SARIF results to GitHub
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: bandit-results.sarif

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v \
            --cov=scripts --cov=temporal_workers --cov=infrahub \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=50 \
            --junitxml=test-results.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: coverage.xml
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    # TODO: Add Infrahub and Containerlab integration tests in Week 3
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --timeout=300

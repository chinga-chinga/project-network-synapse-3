# PR validation — quality gates for every pull request
name: PR Validation

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "**.py"
      - "**.yml"
      - "**.yaml"
      - "**.j2"
      - "**.json"
      - "playbooks/**"
      - "schemas/**"
      - "templates/**"

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Black format check
        run: black --check --diff .

      - name: isort import sorting check
        run: isort --check-only --diff .

      - name: Pylint
        run: pylint **/*.py --rcfile=.pylintrc --output-format=colorized
        continue-on-error: true

      - name: MyPy type checking
        run: mypy . --config-file=mypy.ini --show-error-codes
        continue-on-error: true

  security-scanning:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Bandit security scan (JSON report)
        run: bandit -r . -f json -o bandit-report.json -x tests,venv,.venv
        continue-on-error: true

      - name: Bandit security scan (SARIF report)
        run: bandit -r . -f sarif -o bandit-results.sarif -x tests,venv,.venv
        continue-on-error: true

      - name: Upload SARIF results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit-results.sarif

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=80 \
            --junitxml=test-results.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: coverage.xml
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-scanning, unit-tests]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## PR Validation Summary"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Code Quality | ${{ needs.code-quality.result }} |"
          echo "| Security Scanning | ${{ needs.security-scanning.result }} |"
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |"
          echo ""

          if [[ "${{ needs.code-quality.result }}" == "failure" ]] || \
             [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
            echo "❌ Required jobs failed — blocking merge."
            exit 1
          fi

          echo "✅ All required checks passed."

# Release — build changelog, tag, and create GitHub Release
#
# Trigger manually via Actions → Release → Run workflow.
# Specify the version (e.g., "0.2.0").
#
# Prerequisites (one-time admin setup):
#   1. In Settings → Rules → Rulesets → "Protect main" →
#      Bypass list → add "Repository admin" role (Always).
#   2. Create a Fine-grained PAT with Contents: Read/Write,
#      scoped to this repo only. Store as RELEASE_PAT secret.
#
# What this workflow does:
#   1. Validates all closed issues have changelog fragments
#   2. Compiles fragments into CHANGELOG.md via towncrier
#   3. Commits updated CHANGELOG.md to main
#   4. Creates and pushes git tag (v<version>)
#   5. Creates GitHub Release with generated notes
#   6. Tag push triggers build-artifacts.yml automatically

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.2.0)"
        required: true
        type: string
      skip-validation:
        description: >-
          Skip completeness validation (emergency releases only)
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: read

env:
  PYTHON_VERSION: "3.11"
  UV_VERSION: "latest"

jobs:
  release:
    name: Release v${{ inputs.version }}
    runs-on: ubuntu-latest
    steps:
      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid version format: $VERSION"
            echo "Expected: MAJOR.MINOR.PATCH (e.g., 0.2.0)"
            exit 1
          fi

      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT }}

      - uses: astral-sh/setup-uv@v7
        with:
          version: ${{ env.UV_VERSION }}

      - uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --group dev

      # ── Layer 3: Completeness validation ──────────────────
      - name: Validate changelog completeness
        if: ${{ !inputs.skip-validation }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          echo "══════════════════════════════════════════════"
          echo "  Changelog Completeness Validation"
          echo "══════════════════════════════════════════════"
          echo ""

          # Find the last version tag
          LAST_TAG=$(git tag -l 'v*' --sort=-version:refname \
            | head -n1)

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found. Using initial commit."
            SINCE_DATE=$(git log --reverse --format='%aI' \
              | head -n1)
          else
            echo "Last tag: $LAST_TAG"
            SINCE_DATE=$(git log -1 --format='%aI' "$LAST_TAG")
          fi

          echo "Checking issues closed since: $SINCE_DATE"
          echo ""

          # Get closed issues (completed, not "not planned"),
          # excluding issues with exclusion labels.
          ISSUES=$(gh issue list \
            --state closed \
            --limit 500 \
            --search "closed:>=${SINCE_DATE} reason:completed" \
            --json number,title,labels \
            --jq '
              [.[] | select(
                ([.labels[].name] | any(
                  . == "duplicate" or . == "wontfix" or
                  . == "question" or . == "invalid" or
                  . == "skip-changelog"
                )) | not
              )]
            ')

          ISSUE_COUNT=$(echo "$ISSUES" | jq 'length')
          echo "Found $ISSUE_COUNT closed issues to check."
          echo ""

          MISSING=""
          MISSING_COUNT=0

          for row in $(echo "$ISSUES" \
            | jq -r '.[] | @base64'); do
            _jq() {
              echo "$row" | base64 --decode | jq -r "$1"
            }
            NUM=$(_jq '.number')
            TITLE=$(_jq '.title')

            FOUND=$(ls changelog/${NUM}.*.md 2>/dev/null \
              || true)
            if [ -z "$FOUND" ]; then
              MISSING="${MISSING}  - #${NUM}: ${TITLE}\n"
              MISSING_COUNT=$((MISSING_COUNT + 1))
            else
              echo "  [ok] #${NUM}: ${TITLE}"
            fi
          done

          echo ""

          # Orphan fragment check (warnings only)
          echo "── Orphan fragment check ──"
          ORPHANS=""
          for frag in changelog/*.md; do
            [ "$frag" = "changelog/.gitkeep" ] && continue
            BASENAME=$(basename "$frag")
            ISSUE_NUM=$(echo "$BASENAME" \
              | grep -oE '^[0-9]+' || true)
            if [ -n "$ISSUE_NUM" ]; then
              IN_SET=$(echo "$ISSUES" \
                | jq --arg n "$ISSUE_NUM" \
                '[.[] | select(.number == ($n | tonumber))]
                | length')
              if [ "$IN_SET" = "0" ]; then
                ORPHANS="${ORPHANS}  - ${BASENAME}"
                ORPHANS="${ORPHANS} (issue #${ISSUE_NUM}"
                ORPHANS="${ORPHANS} not in closed set)\n"
              fi
            fi
          done

          if [ -n "$ORPHANS" ]; then
            echo "WARNING: Orphan fragments found:"
            echo -e "$ORPHANS"
          else
            echo "  No orphan fragments found."
          fi

          echo ""

          if [ "$MISSING_COUNT" -gt 0 ]; then
            echo "══════════════════════════════════════════════"
            echo "  FAILED: $MISSING_COUNT issue(s) missing"
            echo "  changelog fragments:"
            echo "══════════════════════════════════════════════"
            echo -e "$MISSING"
            echo ""
            echo "To fix:"
            echo "  1. Add fragments:"
            echo "     echo \"Desc\" > changelog/<N>.added.md"
            echo "  2. Or add 'skip-changelog' label to issues"
            echo "     that don't need fragments"
            echo "  3. Re-run this release workflow"
            exit 1
          fi

          echo "Completeness validation passed."

      # ── Generate release notes (draft) ────────────────────
      - name: Generate release notes
        id: notes
        env:
          VERSION: ${{ inputs.version }}
        run: |
          echo "Generating release notes for v${VERSION}..."

          NOTES=$(uv run towncrier build \
            --draft --version "$VERSION" 2>/dev/null)

          echo "notes<<RELEASE_NOTES_EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "RELEASE_NOTES_EOF" >> "$GITHUB_OUTPUT"

          echo ""
          echo "── Preview ──"
          echo "$NOTES"

      # ── Build changelog (removes fragments) ───────────────
      - name: Build changelog
        env:
          VERSION: ${{ inputs.version }}
        run: |
          uv run towncrier build --version "$VERSION" --yes

      # ── Commit and tag ────────────────────────────────────
      - name: Commit changelog update
        env:
          VERSION: ${{ inputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email \
            "41898282+github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md changelog/
          git commit -m "chore: release v${VERSION}

          - Updated CHANGELOG.md via towncrier
          - Removed compiled changelog fragments"

      - name: Create and push tag
        env:
          VERSION: ${{ inputs.version }}
        run: |
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin main --follow-tags

      # ── Create GitHub Release ─────────────────────────────
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
          NOTES: ${{ steps.notes.outputs.notes }}
        run: |
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes "$NOTES" \
            --verify-tag
